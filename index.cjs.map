{"version":3,"file":"index.cjs","sources":["index.js"],"sourcesContent":["#!/usr/bin/env node\n\n/*!\n * develarms\n * @author Satoshi Soma (https://github.com/amekusa)\n */\n\nimport * as fs from 'node:fs';\nimport process from 'node:process';\nimport cp from 'node:child_process';\nimport satisfies from 'semver/functions/satisfies';\n\n// options\nconst opts = {\n\tdryRun: '',\n\tconfig: {\n\t\tfile: 'package.json',\n\t\tkey: 'develarms'\n\t}\n};\n\n// parse command line arguments\nlet args = process.argv.slice(2);\nfor (let i = 0; i < args.length; i++) {\n\tswitch (args[i]) {\n\tcase '-n':\n\tcase '--dryRun':\n\tcase '--dry-run':\n\t\topts.dryRun = ' --dry-run';\n\t\tcontinue;\n\t}\n\tif ((i + 1) == args.length) break;\n\tswitch (args[i]) {\n\tcase '-c':\n\tcase '--config':\n\t\topts.config.file = args[++i];\n\t\tcontinue;\n\tcase '--configKey':\n\tcase '--config-key':\n\t\topts.config.key = args[++i];\n\t\tcontinue;\n\t}\n}\n\nfunction main() {\n\tlet config = JSON.parse(fs.readFileSync(opts.config.file));\n\tif (!(opts.config.key in config)) throw new Error(`Config key '${opts.config.key}' not found in ${opts.config.file}`);\n\tconfig = config[opts.config.key];\n\tlet deps = {};\n\tlet keys = [\n\t\t'pkgs',\n\t\t'deps',\n\t\t'packages',\n\t\t'dependencies'\n\t];\n\tfor (let i = 0; i < keys.length; i++) {\n\t\tif (!(keys[i] in config)) continue;\n\t\tif (typeof config[keys[i]] != 'object') continue;\n\t\tdeps = Object.assign(deps, config[keys[i]]);\n\t}\n\tresolveDeps(deps).then(() => {\n\t\tconsole.log(`Setup complete.`);\n\t}).catch(e => {\n\t\tconsole.error(e);\n\t\tconsole.error(`Setup failed.`);\n\t\tprocess.exit(1);\n\t});\n}\n\nfunction exec(cmd) {\n\treturn new Promise((resolve, reject) => {\n\t\tconsole.log(`[exec]`, cmd);\n\t\tcp.exec(cmd, {}, function(err, out) {\n\t\t\tif (!err) return resolve(out);\n\t\t\treturn reject(err);\n\t\t});\n\t});\n}\n\nasync function resolveDeps(deps) {\n\tlet names = Object.keys(deps);\n\tif (!names.length) {\n\t\tconsole.log(`No dependencies.`);\n\t\treturn;\n\t}\n\tconsole.log(`Resolving dependencies:`, deps, `...`);\n\n\t// populate existent packages\n\tlet l, g;\n\tawait Promise.all([\n\t\t// locals\n\t\texec(`npm ls ${names.join(' ')} --json --depth=0`).then(out => {\n\t\t\tl = JSON.parse(out).dependencies || {};\n\t\t}).catch(() => { l = {} }),\n\t\t// globals\n\t\texec(`npm ls -g ${names.join(' ')} --json --depth=0`).then(out => {\n\t\t\tg = JSON.parse(out).dependencies || {};\n\t\t}).catch(() => { g = {} })\n\t]);\n\tlet exist = Object.assign(g, l);\n\tconsole.log(`Existent dependencies:`, exist);\n\n\t// calculate which packages should be installed\n\tlet installs = [];\n\tfor (let i in deps) {\n\t\tlet I = deps[i];\n\t\tif (typeof I == 'string') I = { version: I }; // support one-liner\n\t\tif (!I.version) {\n\t\t\tconsole.warn(`The dependency '${i}' is skipped due to a lack of 'version' info.`);\n\t\t\tcontinue;\n\t\t}\n\t\tif (i in exist && satisfies(exist[i].version, I.version)) {\n\t\t\tconsole.log(`You have already had a sufficient version of '${i}'.`, `\\n - Existent: ${exist[i].version}`, `\\n - Required: ${I.version}`);\n\t\t\tcontinue;\n\t\t}\n\t\tinstalls.push(i+'@'+I.version);\n\t}\n\tif (!installs.length) {\n\t\tconsole.log(`Nothing to install.`);\n\t\treturn;\n\t}\n\n\t// install packages\n\tconsole.log(`Installing ${installs.join(', ')} ...`);\n\treturn exec(`npm i --no-save${opts.dryRun} ${installs.join(' ')}`).then(() => {\n\t\tconsole.log(`Installation complete.`);\n\t\tconsole.log(`All the dependencies have been resolved.`);\n\n\t}).catch(e => {\n\t\tconsole.error(e)\n\t\tthrow new Error(`Installation failed.`);\n\t});\n}\n\nmain();\n"],"names":["fs"],"mappings":"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"}